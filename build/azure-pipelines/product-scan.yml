trigger: none
pr: none

stages:
- stage: ScanBinaries
  jobs:
  - job: VSCode
    pool:
      vmImage: VS2017-Win2016
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: "12.14.1"

    - task: geeklearningio.gl-vsts-tasks-yarn.yarn-installer-task.YarnInstaller@2
      inputs:
        versionSpec: "1.x"

    - powershell: |
        . build/azure-pipelines/win32/exec.ps1
        $ErrorActionPreference = "Stop"
        $env:CHILD_CONCURRENCY="1"
        exec { yarn --frozen-lockfile }
      displayName: Install dependencies

    - powershell: |
        . build/azure-pipelines/win32/exec.ps1
        $ErrorActionPreference = "Stop"
        exec { yarn gulp "vscode-symbols-win32-x64" }
      displayName: Download Symbols

    - powershell: |
        . build/azure-pipelines/win32/exec.ps1
        $ErrorActionPreference = "Stop"
        exec { ls $(agent.builddirectory)\scanbin\*.exe -recurse }
      displayName: List Binaries

    - powershell: |
        . build/azure-pipelines/win32/exec.ps1
        $ErrorActionPreference = "Stop"
        exec { ls $(agent.builddirectory)\scanbin\*.pdb -recurse }
      displayName: List Symbols

    - task: BinSkim@3
      inputs:
        toolVersion: Latest
        InputType:   CommandLine
        arguments:   analyze $(agent.builddirectory)\scanbin\*.dll;$(agent.builddirectory)\scanbin\*.exe --recurse
